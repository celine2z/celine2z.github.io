<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>아이 해열제 계산 · 기록 · 농도그래프 (v3.6 · concentration)</title>
<style>
  :root{ --bg:#f6f7f9;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--ring:#e5e7eb;
    --pink:#ff5a7a;--pinkBg:#ffe8ee; --blue:#4f67ff;--blueBg:#e9edff;
    --green:#10b981;--greenBg:#e6fff6;}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-size:13px}
  .wrap{max-width:920px;margin:0 auto;padding:8px}
  h1{font-size:17px;margin:2px 0 8px}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:8px}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .section-title{font-size:12px;color:var(--muted);margin:0 0 6px}
  .chip{font-size:11px;padding:2px 6px;border-radius:999px;background:#f1f5f9;color:#0f172a}
  .pill{border:none;border-radius:10px;padding:7px 9px;background:#0ea5e9;color:#fff;cursor:pointer;font-size:13px}
  .ghost{background:#f1f5f9;color:#0f172a}
  .ghost:hover{background:#e2e8f0}
  .kicker{font-size:11px;color:var(--muted)}
  .big{font-size:17px;font-weight:700}
  .line{display:flex;align-items:center;gap:8px;padding:5px 7px;border:1px solid var(--ring);border-radius:10px;background:#fafbff}
  .line .label{min-width:92px;font-weight:700}
  .inline-input{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:9px;padding:2px 4px}
  .inline-input input{width:38px;border:none;outline:none;font:inherit;background:transparent;text-align:right}
  .inline-input .sep{opacity:.6}
  input[type="number"],input[type="datetime-local"]{font:inherit;border:1px solid #e5e7eb;border-radius:9px;padding:6px 7px;background:#fff}
  input[type="number"]{width:78px}
  .drug-btn{border:none;border-radius:10px;padding:7px 9px;cursor:pointer;font-weight:700;font-size:13px}
  .drug-ap{background:var(--pinkBg);color:var(--pink)}
  .drug-ib{background:var(--blueBg);color:var(--blue)}
  .drug-dx{background:var(--greenBg);color:#069e75}
  .ok{background:#111827;color:#fff}
  .seg{display:inline-flex;border:1px solid #e5e7eb;border-radius:9px;overflow:hidden}
  .seg button{padding:6px 10px;border:0;background:#fff;color:#0f172a;cursor:pointer}
  .seg button.active{background:#0f172a;color:#fff}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  .toolbar select{border:1px solid #e5e7eb;border-radius:9px;padding:6px 8px;background:#fff;font:inherit}
  .chart-wrap{position:relative}
  canvas{width:100%;max-width:100%;height:34vh;background:#fff;border-radius:10px;display:block}
  .summary{display:flex;align-items:center;gap:10px;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:8px;margin-top:8px}
  .summary .title{font-size:15px;font-weight:800;margin-right:8px}
  .badge{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.good{background:#d1fae5;color:#065f46}
  .donuts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:760px){ .donuts{grid-template-columns:1fr} }
  .donut-card{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  .donut-label{font-weight:800}
  .donut-sub{font-size:12px;color:#64748b}
  .donut-val{font-size:16px;font-weight:800}
  .donut{width:62px;height:62px;position:relative}
  .donut svg{transform:rotate(-90deg)}
  .donut .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:11px;color:#64748b;text-align:left;padding:6px 8px}
  tbody tr{background:#ffffff;border:1px solid #e5e7eb}
  tbody td{padding:8px 10px;vertical-align:middle}
  tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  td.right{text-align:right}
  .tag{padding:2px 6px;border-radius:999px;font-size:11px;font-weight:700;white-space:nowrap}
  .tag.ap{background:var(--pinkBg);color:var(--pink)}
  .tag.ib{background:var(--blueBg);color:var(--blue)}
  .tag.dx{background:var(--greenBg);color:#069e75}
  .nextbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;margin-bottom:8px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:4px}
</style>
</head>
<body>
<div class="wrap">
  <h1>아이 해열제 계산 · 기록 · 농도그래프</h1>

  <div class="grid cols-2">
    <div class="card">
      <div class="section-title">기본 정보</div>
      <div class="row">
        <span class="chip">체중(kg)</span>
        <input id="weight" type="number" step="0.1" min="3" max="80" />
        <button id="saveWeight" class="pill ghost">저장</button>
        <span id="weightHint" class="kicker"></span>
      </div>

      <div class="section-title" style="margin-top:4px">현용 현탁농도 (필요시만 변경)</div>
      <div class="line">
        <div class="label">아세트아미노펜</div>
        <div class="inline-input"><input id="concAPAP" type="number" step="1" value="160"><span class="sep">mg /</span><input id="concAPAPml" type="number" step="0.1" value="5"><span class="sep">ml</span></div>
      </div>
      <div class="line">
        <div class="label">이부프로펜</div>
        <div class="inline-input"><input id="concIBU" type="number" step="1" value="100"><span class="sep">mg /</span><input id="concIBUml" type="number" step="0.1" value="5"><span class="sep">ml</span></div>
      </div>
      <div class="line">
        <div class="label">덱시부프로펜</div>
        <div class="inline-input"><input id="concDEX" type="number" step="1" value="60"><span class="sep">mg /</span><input id="concDEXml" type="number" step="0.1" value="5"><span class="sep">ml</span></div>
      </div>
      <div class="kicker" style="margin-top:2px">숫자를 바꾸면 자동 저장돼요.</div>
    </div>

    <div class="card">
      <div class="row">
        <button class="drug-btn drug-ap" onclick="setDose('APAP')">아세트아미노펜</button>
        <button class="drug-btn drug-ib" onclick="setDose('IBU')">이부프로펜</button>
        <button class="drug-btn drug-dx" onclick="setDose('DEX')">덱시부프로펜</button>
      </div>

      <div id="doseBox" style="margin-top:6px">
        <div class="row">
          <div class="chip">권장 1회 용량</div>
          <div id="rangeText" class="big"></div>
        </div>

        <div class="row">
          <div class="chip">투여 용량</div>
          <div class="seg" id="unitSeg">
            <button type="button" data-u="mg" class="active" onclick="setUnit('mg')">mg</button>
            <button type="button" data-u="ml" onclick="setUnit('ml')">ml</button>
          </div>
          <input id="doseVal" type="number" step="1" placeholder="값 입력" />
          <span id="doseConv" class="kicker"></span>
        </div>

        <div class="row">
          <div class="chip">복용 시간</div>
          <input id="doseTime" type="datetime-local" />
          <button class="pill ok" onclick="addDose()">기록하기</button>
        </div>

        <div class="kicker" id="maxDaily"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="nextBar" class="nextbar" style="display:none"></div>

    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="toolbar">
        <button class="pill ghost" onclick="pan(-2)">← 2h</button>
        <button class="pill ghost" onclick="pan(-6)">← 6h</button>
        <button class="pill ghost" onclick="nowCenter()">지금</button>
        <button class="pill ghost" onclick="pan(6)">6h →</button>
        <button class="pill ghost" onclick="pan(12)">12h →</button>
        <select id="windowH" onchange="draw()">
          <option value="12">창: 12h</option>
          <option value="24" selected>창: 24h</option>
          <option value="36">창: 36h</option>
        </select>
        <select id="viewMode" onchange="draw()">
          <option value="overlay" selected>개별 곡선</option>
          <option value="stack">합산 농도</option>
        </select>
        <select id="yMode" onchange="draw()">
          <option value="fixed" selected>Y축: 고정</option>
          <option value="auto">Y축: 자동</option>
        </select>
      </div>
      <div class="kicker" id="ykicker">Y축: <b>혈중 농도(µg/mL)</b></div>
    </div>

    <div class="chart-wrap"><canvas id="chart"></canvas></div>
    <div id="summaryCard" class="summary" style="display:none"></div>

    <div class="row" style="margin-top:8px;justify-content:flex-end">
      <button class="pill ghost" onclick="clearToday()">오늘 기록 삭제</button>
      <button class="pill ghost" onclick="clearAll()">전체 초기화</button>
    </div>

    <div class="kicker">모델: 개선형 Bateman(단일 구획 + 지연흡수). 단위는 실제 농도(µg/mL). 회색 수직선은 현재시각.</div>
  </div>

  <div class="card">
    <h3 style="margin:2px 0 6px">최근 24시간 복용 이력</h3>
    <table id="logTbl">
      <thead><tr><th>시각</th><th>약</th><th class="right">용량 (mg)</th><th class="right">ml</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="dailyTotals" class="kicker"></div>
  </div>

  <div class="card">
    <h3 style="margin:2px 0 6px">오늘 더 먹을 수 있는 양</h3>
    <div class="donuts" id="donutWrap"></div>
  </div>
</div>

<script>
const store = {
  get(){
    try{
      const v = localStorage.getItem('antipyretic_v1');
      const obj = v ? JSON.parse(v) : {};
      if(!Array.isArray(obj.log)) obj.log = [];
      return obj;
    }catch(e){ return { log: [] }; }
  },
  set(d){
    try {
      const prevRaw = localStorage.getItem('antipyretic_v1');
      let prev = {};
      try{ prev = prevRaw ? JSON.parse(prevRaw) : {}; }catch(e){ prev = {}; }
      const merged = { ...prev, ...(d||{}) };
      if(!('log' in (d||{}))) merged.log = prev.log || [];
      localStorage.setItem('antipyretic_v1', JSON.stringify(merged));
    } catch(e) { console.error('저장 중 오류', e); }
  }
};

const DRUGS = {
  APAP: {name:'아세트아미노펜', Ka:1.2, Ke:0.25, Tlag:0.2, VdKg:0.95, recMgKg:[10,15], maxDailyMgKgRange:[60,75], key:'APAP', color:'#ff5a7a', tagClass:'ap'},
  IBU:  {name:'이부프로펜',   Ka:1.0, Ke:0.20, Tlag:0.3, VdKg:0.10, recMgKg:[5,10],  maxDailyMgKgRange:[30,40], key:'IBU',  color:'#4f67ff', tagClass:'ib'},
  DEX:  {name:'덱시부프로펜', Ka:1.1, Ke:0.23, Tlag:0.3, VdKg:0.12, recMgKg:[5,7],   maxDailyMgKgRange:[20,30], key:'DEX',  color:'#10b981', tagClass:'dx'}
};

function getConcs(){
  const s = store.get();
  return { APAP:(s.concAPAP||160)/(s.concAPAPml||5),
           IBU:(s.concIBU||100)/(s.concIBUml||5),
           DEX:(s.concDEX||60)/(s.concDEXml||5) };
}

let active='APAP'; let centerTs=Date.now(); let unit='mg';

function init(){
  const s = store.get();
  document.getElementById('weight').value = s.weight||'';
  document.getElementById('saveWeight').onclick = ()=>{
    const s2 = store.get(); s2.weight = parseFloat(document.getElementById('weight').value)||null; store.set(s2);
    refreshDoseBox(); renderLog(); draw(); renderDonuts(); renderNextBar();
  };
  ['APAP','IBU','DEX'].forEach(k=>{
    const low = k==='APAP'?'concAPAP':k==='IBU'?'concIBU':'concDEX';
    const lowml = low+'ml';
    document.getElementById(low).value = s[low] ?? (k==='APAP'?160:k==='IBU'?100:60);
    document.getElementById(lowml).value = s[lowml] ?? 5;
    document.getElementById(low).addEventListener('input',saveConcs);
    document.getElementById(lowml).addEventListener('input',saveConcs);
  });
  document.getElementById('doseTime').value = toLocalInputValue(new Date());
  document.getElementById('doseVal').addEventListener('input',updateConversionHint);
  refreshDoseBox(); renderLog(); draw(); renderDonuts(); renderNextBar();
  window.addEventListener('resize', ()=>draw());
}

function setUnit(u){
  unit=u;
  const seg=document.getElementById('unitSeg').querySelectorAll('button');
  seg.forEach(b=>b.classList.toggle('active', b.dataset.u===u));
  document.getElementById('doseVal').value='';
  updateConversionHint();
}

function updateConversionHint(){
  const v = parseFloat(document.getElementById('doseVal').value);
  const concs=getConcs();
  const mLperMg = 1/concs[active];
  const el = document.getElementById('doseConv');
  if(!v){ el.textContent=''; return; }
  if(unit==='mg'){ el.textContent = `→ ${(v*mLperMg).toFixed(1)} ml 예상`; }
  else{ el.textContent = `→ ${(v/mLperMg).toFixed(0)} mg 환산`; }
}

function saveConcs(){
  const s = store.get();
  ['concAPAP','concAPAPml','concIBU','concIBUml','concDEX','concDEXml'].forEach(id=>{
    s[id] = parseFloat(document.getElementById(id).value);
  });
  store.set(s); refreshDoseBox(); draw(); renderDonuts(); renderLog();
  updateConversionHint();
}

function setDose(k){
  active=k; document.getElementById('doseTime').value = toLocalInputValue(new Date());
  refreshDoseBox(); updateConversionHint();
}

function refreshDoseBox(){
  const w = parseFloat(document.getElementById('weight').value)||0;
  const d = DRUGS[active]; const concs=getConcs();
  const [minMgKg, maxMgKg] = d.recMgKg;
  const minMg = w*minMgKg, maxMg = w*maxMgKg;
  const mLperMg = 1/concs[active];
  document.getElementById('rangeText').textContent = w? `${Math.round(minMg)}~${Math.round(maxMg)} mg (≈ ${(minMg*mLperMg).toFixed(1)}~${(maxMg*mLperMg).toFixed(1)} ml)` : '체중 입력 필요';
  const [lo,hi] = d.maxDailyMgKgRange;
  document.getElementById('maxDaily').innerHTML = `24시간 최대: <b>${lo}~${hi} mg/kg</b> (기관마다 차이). 보수 계산은 낮은 값으로 평가.`;
  document.getElementById('weightHint').textContent = w? `권장 범위 자동 계산 중` : '';
}

function addDose(){
  const s = store.get(); const arr = s.log || [];
  let v = parseFloat(document.getElementById('doseVal').value);
  if(!v){ alert('용량을 입력해주세요.'); return; }
  if(unit==='ml'){ const conc = getConcs()[active]; v = Math.round(v * conc); }
  else{ v = Math.round(v); }
  const t = new Date(document.getElementById('doseTime').value);
  if(isNaN(t.getTime())){ alert('시간을 확인해주세요.'); return; }
  arr.push({ts: t.toISOString(), drug: active, mg: v});
  s.log = arr; store.set(s);
  document.getElementById('doseVal').value=''; updateConversionHint();
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

function renderLog(){
  const s = store.get(); const arr = (s.log||[]).filter(Boolean);
  const since24 = Date.now()-24*3600*1000;
  const rows = arr.filter(x=>new Date(x.ts).getTime()>=since24).sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  const tbody = document.querySelector('#logTbl tbody'); tbody.innerHTML='';
  const concs = getConcs();
  rows.forEach((x)=>{
    const mL = (x.mg * (1/concs[x.drug])).toFixed(1);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmt(new Date(x.ts))}</td>
                    <td><span class="tag ${DRUGS[x.drug].tagClass}">${DRUGS[x.drug].name}</span></td>
                    <td class="right">${x.mg}</td>
                    <td class="right">${mL}</td>
                    <td><button class="pill ghost" onclick="del('${x.ts}')">삭제</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('dailyTotals').textContent='';
}

function del(ts){
  const s = store.get(); s.log = (s.log||[]).filter(x=>x.ts!==ts); store.set(s);
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

function clearToday(){
  const s = store.get();
  const start = new Date(); start.setHours(0,0,0,0);
  s.log = (s.log||[]).filter(x=>new Date(x.ts).getTime()<start.getTime()); store.set(s);
  renderLog(); draw(); renderDonuts(); renderNextBar();
}
function clearAll(){
  if(!confirm('모든 기록을 삭제할까요?')) return;
  const prev = store.get();
  store.set({ weight: prev.weight, concAPAP:prev.concAPAP, concAPAPml:prev.concAPAPml,
              concIBU:prev.concIBU, concIBUml:prev.concIBUml, concDEX:prev.concDEX, concDEXml:prev.concDEXml, log: [] });
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

function toLocalInputValue(d){
  const z = new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,16);
}
function fmt(d){
  const p = n=>String(n).padStart(2,'0');
  return `${d.getMonth()+1}/${d.getDate()} ${p(d.getHours())}:${p(d.getMinutes())}`;
}

// ===== PK engine (absolute concentration, µg/mL) =====
function pkSumConc(drugKey, t0, t1, stepMin){
  const s = store.get(); const arr = s.log||[];
  const doses = arr.filter(x=>x.drug===drugKey);
  const d = DRUGS[drugKey];
  const Ka = d.Ka, Ke=d.Ke, Tlag=d.Tlag||0;
  const w = parseFloat(document.getElementById('weight').value)||0;
  const VdL = (d.VdKg||0)*w; // L
  const F = 1.0; // bioavailability approx
  const points = [];
  for(let t=t0; t<=t1; t+=stepMin*60*1000){
    let C = 0;
    for(const dd of doses){
      const dt_hr = (t - new Date(dd.ts).getTime())/3600000;
      const tt = dt_hr - Tlag;
      if(VdL>0 && tt>0){
        const term = (Ka/(Ka-Ke))*(Math.exp(-Ke*tt) - Math.exp(-Ka*tt));
        C += (dd.mg * F / VdL) * term; // mg/L == µg/mL
      }
    }
    points.push({t, C: Math.max(0,C)});
  }
  return points;
}

function getGlobalMaxConc(){
  const start = Date.now()-24*3600*1000;
  const end   = Date.now()+12*3600*1000;
  const step = 6;
  let maxC = 1;
  ['APAP','IBU','DEX'].forEach(k=>{
    const pts = pkSumConc(k, start, end, step);
    pts.forEach(p=>{ if(p.C>maxC) maxC=p.C; });
  });
  return maxC || 1;
}

function getSeriesForWindowConc(start, end, stepMin, modeY){
  const gmax = modeY==='fixed' ? getGlobalMaxConc() : 0;
  function series(k){
    const raw = pkSumConc(k, start, end, stepMin);
    let maxC = 1; if(modeY==='auto'){ raw.forEach(p=>{ if(p.C>maxC) maxC=p.C; }); }
    const denom = modeY==='fixed'? gmax : maxC;
    return raw.map(p=>({t:p.t, y: denom? (p.C/denom) : 0, abs:p.C}));
  }
  return {
    A: series('APAP'),
    I: series('IBU'),
    D: series('DEX'),
    denom: modeY==='fixed'? gmax : null,
    yUnit: 'conc'
  };
}

function drawYAxisLabels(ctx, yPos, series){
  ctx.fillStyle='#64748b'; ctx.font='11px ui-sans-serif';
  const ticks=[0,0.25,0.5,0.75,1.0];
  if(series && series.yUnit==='conc'){
    const denom = series.denom || 1;
    ticks.forEach(v=>{ const y=yPos(v); const val = (v*denom).toFixed(2); ctx.fillText(val, 8, y+4); });
    ctx.fillText('µg/mL', 8, 14);
  }else{
    ticks.forEach(v=>{ const y=yPos(v); ctx.fillText(String(v), 8, y+4); });
  }
}

function getCurrentIndices(A,I,D, start, end){
  const now = Date.now();
  const arrLen = A.length;
  const idx = Math.round((now - start) / ((end-start)/(arrLen-1)));
  function clamp(n){return Math.max(0, Math.min(arrLen-1, n));}
  const i = clamp(idx);
  return {
    now,
    apap: A[i]?.y || 0,
    ibu:  I[i]?.y || 0,
    dex:  D[i]?.y || 0,
    combo: Math.min(1, ((A[i]?.y||0)+(I[i]?.y||0)+(D[i]?.y||0))/3)
  };
}

function renderSummaryCard(indices, series){
  const el = document.getElementById('summaryCard');
  const time = new Date(indices.now);
  const p2 = n=>String(n).padStart(2,'0');
  const hhmm = `${p2(time.getHours())}:${p2(time.getMinutes())}`;
  el.className = `summary`; el.style.display = 'flex';
  const denom = series.denom || 1;
  el.innerHTML = `
    <span class="badge good">현재</span>
    <div>
      <div><span class="title">추정 혈중 농도</span><b>${(indices.combo*denom).toFixed(2)}</b> µg/mL · ${hhmm}</div>
      <div class="kicker">아세 ${(indices.apap*denom).toFixed(2)} · 이부 ${(indices.ibu*denom).toFixed(2)} · 덱시 ${(indices.dex*denom).toFixed(2)} (µg/mL)</div>
    </div>`;
}

function donutSVG({size=62,stroke=8,percent=0.3,color='#0ea5e9',bg:'#eef2ff'}){
  const r = (size - stroke)/2;
  const c = 2*Math.PI*r;
  const p = Math.max(0, Math.min(1, percent));
  const dash = `${p*c} ${c}`;
  return `<div class="donut">
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="${bg}" stroke-width="${stroke}" fill="none" />
      <circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="${color}" stroke-width="${stroke}" fill="none"
              stroke-dasharray="${dash}" stroke-linecap="round" />
    </svg>
    <div class="center">${Math.round(p*100)}%</div>
  </div>`;
}

function renderDonuts(){
  const w = parseFloat(document.getElementById('weight').value)||0;
  const wrap = document.getElementById('donutWrap');
  wrap.innerHTML='';
  if(!w){ wrap.innerHTML='<div class="kicker" style="padding:4px 2px">체중을 입력하면 계산돼요.</div>'; return; }
  const s = store.get(); const arr = s.log||[];
  const since24 = Date.now()-24*3600*1000;
  const in24 = arr.filter(x=>new Date(x.ts).getTime()>=since24);
  const totals = {APAP:0, IBU:0, DEX:0};
  in24.forEach(x=>totals[x.drug]+=x.mg);
  const conc = getConcs();

  const items = [
    {key:'APAP', color:'#ff5a7a'},
    {key:'IBU',  color:'#4f67ff'},
    {key:'DEX',  color:'#10b981'}
  ];
  items.forEach(it=>{
    const maxMg = w*DRUGS[it.key].maxDailyMgKgRange[0];
    const used = totals[it.key]||0;
    const leftMg = Math.max(0, maxMg - used);
    const leftmL = leftMg / conc[it.key];
    const percent = Math.min(1, used / maxMg);
    const card = document.createElement('div'); card.className='donut-card';
    const title = DRUGS[it.key].name;
    card.innerHTML = `${donutSVG({percent,color:it.color,bg:'#eef2f7'})}
      <div>
        <div class="donut-label">${title}</div>
        <div class="donut-sub">오늘 더 먹을 수 있는 양</div>
        <div class="donut-val" style="color:${it.color}">${leftmL.toFixed(1)} ml <span class="donut-sub">(≈ ${Math.round(leftMg)} mg)</span></div>
      </div>`;
    wrap.appendChild(card);
  });
}

function draw(){
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  const cssH = canvas.clientHeight, cssW = canvas.clientWidth;
  if (canvas.width !== cssW || canvas.height !== cssH){ canvas.width = cssW; canvas.height = cssH; }
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const windowH = parseInt(document.getElementById('windowH').value,10);
  const start = centerTs - (windowH/2)*3600*1000;
  const end   = centerTs + (windowH/2)*3600*1000;
  const stepMin = 6;

  const modeY = document.getElementById('yMode').value;
  const series = getSeriesForWindowConc(start,end,stepMin,modeY);

  const padL = 46, padR=8, padTop=8, padB=28;
  const H = canvas.height, W = canvas.width;
  const xPos = t => padL + (W-padL-padR) * ((t-start)/(end-start));
  const yPos = y => { const h = H-padB-padTop; return padTop + h*(1-y); };

  // grid
  (function(){
    const c=ctx; c.strokeStyle='#e5e7eb'; c.beginPath();
    for(let i=0;i<=6;i++){ const x = xPos(start + (end-start)*i/6); c.moveTo(x,padTop); c.lineTo(x,H-padB); }
    for(let j=0;j<=4;j++){ const y = padTop + (H-padB-padTop)*j/4; c.moveTo(padL,y); c.lineTo(W-padR,y); }
    c.stroke();
  })();

  // y-axis labels with µg/mL
  drawYAxisLabels(ctx, yPos, series);

  const datasets = [
    {data:series.A, color:'#ff5a7a', label:'아세트아미노펜'},
    {data:series.I, color:'#4f67ff', label:'이부프로펜'},
    {data:series.D, color:'#10b981', label:'덱시부프로펜'}
  ];

  const mode = document.getElementById('viewMode').value;
  if(mode==='overlay'){
    datasets.forEach((ds,idx)=>{
      ctx.strokeStyle = ds.color; ctx.lineWidth = 2; ctx.beginPath();
      ds.data.forEach((p,i)=>{ const x=xPos(p.t), y=yPos(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
      ctx.fillStyle = ds.color; ctx.fillRect(W-160, 32+16*idx, 10,10);
      ctx.fillStyle = '#0f172a'; ctx.fillText(ds.label, W-145, 40+16*idx);
    });
  }else{
    const n = series.A.map((p,i)=>({t:p.t, y:Math.min(1,(p.y + series.I[i].y + series.D[i].y)/3)}));
    ctx.strokeStyle = '#111827'; ctx.lineWidth = 2; ctx.beginPath();
    n.forEach((p,i)=>{ const x=xPos(p.t), y=yPos(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
    ctx.fillStyle = '#111827'; ctx.fillRect(W-160, 32, 10,10);
    ctx.fillStyle = '#0f172a'; ctx.fillText('합산 농도(정규화)', W-145, 40);
  }

  // now line
  const now = Date.now();
  if(now>=start && now<=end){
    const x = xPos(now);
    ctx.strokeStyle = 'rgba(2,6,23,0.25)'; ctx.lineWidth = 2; ctx.beginPath();
    ctx.moveTo(x, padTop); ctx.lineTo(x, H-padB); ctx.stroke();
    ctx.fillStyle = 'rgba(2,6,23,0.25)'; ctx.fillRect(x-2, padTop-4, 4, 6);
  }

  // x-axis labels
  ctx.fillStyle='#0f172a'; ctx.font='11px ui-sans-serif';
  for(let i=0;i<=6;i++){
    const t = new Date(start + (end-start)*i/6);
    const label = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    ctx.fillText(label, padL + (W-padL-padR)*i/6 - 12, H-10);
  }

  const idxs = getCurrentIndices(series.A,series.I,series.D,start,end);
  renderSummaryCard(idxs, series);
}

function pan(h){ centerTs += h*3600*1000; draw(); }
function nowCenter(){ centerTs = Date.now(); draw(); }

function renderNextBar(){
  const bar = document.getElementById('nextBar');
  const s = store.get(); const arr=(s.log||[]).slice().sort((a,b)=>Date.parse(b.ts)-Date.parse(a.ts));
  if(!arr.length){ bar.style.display='none'; return; }
  bar.style.display='flex';

  const last = arr[0];
  const now = Date.now();
  function fmtHM(ms){
    const m = Math.max(0, Math.floor(ms/60000));
    if(m<60) return `${m}분`; const h = Math.floor(m/60), r = m%60; return `${h}시간 ${r}분`;
  }
  const elapsed = fmtHM(now - Date.parse(last.ts));

  const rule = {
    APAP: { self: 4, cross: 2 },
    IBU:  { self: 6, cross: 2 },
    DEX:  { self: 6, cross: 2 }
  };
  const plusH = (ts,h) => new Date(Date.parse(ts) + h*3600*1000);
  let apapNext='-', ibuNext='-', dexNext='-';
  if(last.drug==='APAP'){
    apapNext = plusH(last.ts, rule.APAP.self);
    ibuNext  = plusH(last.ts, rule.APAP.cross);
    dexNext  = plusH(last.ts, rule.APAP.cross);
  }else if(last.drug==='IBU'){
    apapNext = plusH(last.ts, rule.IBU.cross);
    ibuNext  = plusH(last.ts, rule.IBU.self);
    dexNext  = plusH(last.ts, rule.IBU.self);
  }else if(last.drug==='DEX'){
    apapNext = plusH(last.ts, rule.DEX.cross);
    ibuNext  = plusH(last.ts, rule.DEX.self);
    dexNext  = plusH(last.ts, rule.DEX.self);
  }
  const fmtOut = d => (d==='-'?'-':fmt(d));
  bar.innerHTML = `<b>마지막 복용:</b> ${fmt(new Date(Date.parse(last.ts)))} <span class="kicker">(경과 ${elapsed})</span><br>
    <span class="dot" style="background:var(--pink)"></span>아세트 다음 <b>${fmtOut(apapNext)}</b>
    &nbsp; <span class="dot" style="background:var(--blue)"></span>이부 다음 <b>${fmtOut(ibuNext)}</b>
    &nbsp; <span class="dot" style="background:#10b981"></span>덱시 다음 <b>${fmtOut(dexNext)}</b>`;
}

window.addEventListener('load', init);
</script>
</body>
</html>

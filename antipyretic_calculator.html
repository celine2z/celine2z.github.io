
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>아이 해열제 계산 · 기록 · 농도그래프</title>
<style>
  :root{
    --bg:#f7f7f8;--card:#ffffff;--ink:#111;--muted:#666;--accent:#ff4d6d;--accent2:#5a67d8;--ok:#0ea5e9;
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,apple color emoji,Segoe UI Emoji,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:880px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:8px 0 16px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:720px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted)}
  input,select,button{font:inherit;border:1px solid #ddd;border-radius:10px;padding:10px 12px;background:#fff}
  input[type="number"]{width:120px}
  button{cursor:pointer}
  .pill{border-radius:999px;padding:8px 12px;border:none}
  .pill.acet{background:#ffe3ea}
  .pill.ibu{background:#e8edff}
  .pill.dex{background:#e8fff5}
  .kicker{font-size:12px;color:var(--muted)}
  .big{font-size:22px;font-weight:700}
  .warn{color:#b91c1c}
  canvas{width:100%;max-width:100%;height:260px;background:#fff;border-radius:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
  .right{text-align:right}
  .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a}
  .muted{color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <h1>아이 해열제 계산 · 기록 · 농도그래프</h1>

  <div class="grid cols-2">
    <div class="card">
      <div class="row">
        <label>체중(kg)</label>
        <input id="weight" type="number" step="0.1" min="3" max="80" />
        <button id="saveWeight" class="pill">저장</button>
        <span id="weightHint" class="kicker"></span>
      </div>
      <div class="row" style="margin-top:8px">
        <label>현용 현탁농도 (변경 가능)</label>
      </div>
      <div class="row">
        <span class="badge">아세트아미노펜</span>
        <input id="concAPAP" type="number" step="1" value="160" /> mg /
        <input id="concAPAPml" type="number" step="0.1" value="5" /> mL
      </div>
      <div class="row">
        <span class="badge">이부프로펜</span>
        <input id="concIBU" type="number" step="1" value="100" /> mg /
        <input id="concIBUml" type="number" step="0.1" value="5" /> mL
      </div>
      <div class="row">
        <span class="badge">덱시부프로펜</span>
        <input id="concDEX" type="number" step="1" value="60" /> mg /
        <input id="concDEXml" type="number" step="0.1" value="5" /> mL
      </div>
      <p class="kicker">※ 병마다 농도가 다를 수 있어요. 숫자를 바꾸면 자동 저장됩니다.</p>
    </div>

    <div class="card">
      <div class="row">
        <button class="pill acet" onclick="setDose('APAP')">아세트아미노펜</button>
        <button class="pill ibu" onclick="setDose('IBU')">이부프로펜</button>
        <button class="pill dex" onclick="setDose('DEX')">덱시부프로펜</button>
      </div>

      <div id="doseBox" style="margin-top:10px">
        <div class="row">
          <label>권장 1회 용량</label>
          <div id="rangeText" class="big"></div>
        </div>
        <div class="row">
          <label>이번에 줄 용량</label>
          <input id="doseMg" type="number" step="1" />
          <span id="doseToMl" class="kicker"></span>
        </div>
        <div class="row">
          <label>복용 시각</label>
          <input id="doseTime" type="datetime-local" />
          <button class="pill" onclick="addDose()">기록 & 그래프반영</button>
        </div>
        <div class="kicker" id="maxDaily"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label>그래프 보기</label>
        <select id="viewMode" onchange="draw()">
          <option value="overlay">개별 곡선(겹쳐 보기)</option>
          <option value="stack">효과 지수(합산·정규화)</option>
        </select>
      </div>
      <div class="row">
        <button class="pill" onclick="clearToday()">오늘 기록만 삭제</button>
        <button class="pill" onclick="clearAll()">전체 초기화</button>
      </div>
    </div>
    <canvas id="chart" width="800" height="260"></canvas>
    <div class="kicker">모델: 1-방(compartment) + 1차 흡수(바테만 함수). 반감기/흡수속도는 문헌값 범위 내 보수적으로 설정.</div>
  </div>

  <div class="card">
    <h3 style="margin:4px 0 10px">최근 24시간 복용 이력</h3>
    <table class="table" id="logTbl">
      <thead><tr><th>시각</th><th>약</th><th class="right">용량 (mg)</th><th class="right">mL</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="dailyTotals" class="kicker"></div>
  </div>
</div>

<script>
const store = {
  get(){try{return JSON.parse(localStorage.getItem('antipyretic_v1')||'{}')}catch(e){return {}}},
  set(d){localStorage.setItem('antipyretic_v1',JSON.stringify(d))}
};

const DRUGS = {
  APAP: {name:'아세트아미노펜', tHalf:2.2, Ka:2.0, recMgKg:[10,15], maxDailyMgKgRange:[60,75], key:'APAP'},
  IBU:  {name:'이부프로펜', tHalf:2.0, Ka:1.5, recMgKg:[5,10],  maxDailyMgKgRange:[30,40], key:'IBU'},
  DEX:  {name:'덱시부프로펜', tHalf:2.2, Ka:1.5, recMgKg:[5,7],  maxDailyMgKgRange:[20,30], key:'DEX'}
};

// concentrations (mg per mL)
function getConcs(){
  const s = store.get();
  return {
    APAP: (s.concAPAP||160) / (s.concAPAPml||5),
    IBU:  (s.concIBU ||100) / (s.concIBUml ||5),
    DEX:  (s.concDEX ||60)  / (s.concDEXml ||5),
  };
}

let active = 'APAP';

function init(){
  const s = store.get();
  // weight
  const w = s.weight||'';
  document.getElementById('weight').value = w;
  // conc bindings
  ['APAP','IBU','DEX'].forEach(k=>{
    const low = k==='APAP'?'concAPAP':k==='IBU'?'concIBU':'concDEX';
    const lowml = low+'ml';
    document.getElementById(low).value = s[low] ?? (k==='APAP'?160:k==='IBU'?100:60);
    document.getElementById(lowml).value = s[lowml] ?? 5;
    document.getElementById(low).addEventListener('input',saveConcs);
    document.getElementById(lowml).addEventListener('input',saveConcs);
  });
  document.getElementById('saveWeight').onclick = ()=>{
    const s2 = store.get(); s2.weight = parseFloat(document.getElementById('weight').value)||null; store.set(s2);
    refreshDoseBox();
  };
  document.getElementById('doseTime').value = toLocalInputValue(new Date());
  refreshDoseBox();
  renderLog();
  draw();
}

function saveConcs(){
  const s = store.get();
  ['concAPAP','concAPAPml','concIBU','concIBUml','concDEX','concDEXml'].forEach(id=>{
    s[id] = parseFloat(document.getElementById(id).value);
  });
  store.set(s);
  refreshDoseBox();
  draw();
}

function setDose(k){
  active = k;
  document.getElementById('doseTime').value = toLocalInputValue(new Date());
  refreshDoseBox();
}

function refreshDoseBox(){
  const w = parseFloat(document.getElementById('weight').value)||0;
  const d = DRUGS[active];
  const concs = getConcs();
  const [minMgKg, maxMgKg] = d.recMgKg;
  const minMg = w*minMgKg, maxMg = w*maxMgKg;
  const mLperMg = 1/concs[active];
  document.getElementById('rangeText').textContent = w? `${Math.round(minMg)}–${Math.round(maxMg)} mg (≈ ${(minMg*mLperMg).toFixed(1)}–${(maxMg*mLperMg).toFixed(1)} mL)` : '체중 입력 필요';
  // default dose = 중간값
  document.getElementById('doseMg').value = w? Math.round(w*((minMgKg+maxMgKg)/2)) : '';
  document.getElementById('doseToMl').textContent = w? `→ ${(document.getElementById('doseMg').value * mLperMg).toFixed(1)} mL 예상` : '';
  // daily max text
  const [lo,hi] = d.maxDailyMgKgRange;
  document.getElementById('maxDaily').innerHTML = `24시간 최대: <b>${lo}–${hi} mg/kg</b> 가이드 범위 (기관에 따라 다름). 보수 계산은 낮은 값으로 평가.`;
  document.getElementById('weightHint').textContent = w? `권장 범위 자동 계산 중` : '';
}

function addDose(){
  const s = store.get();
  const arr = s.log || [];
  const mg = parseFloat(document.getElementById('doseMg').value);
  const t = new Date(document.getElementById('doseTime').value);
  if(!mg || isNaN(t.getTime())){ alert('용량과 시각을 확인해주세요.'); return; }
  arr.push({ts: t.toISOString(), drug: active, mg});
  s.log = arr; store.set(s);
  renderLog(); draw();
}

function renderLog(){
  const s = store.get(); const arr = (s.log||[]).filter(Boolean);
  // keep only last 7 days for performance
  const keepAfter = Date.now() - 7*24*3600*1000;
  const tbody = document.querySelector('#logTbl tbody'); tbody.innerHTML='';
  const concs = getConcs();
  const rows = arr.filter(x=>new Date(x.ts).getTime()>=keepAfter).sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  rows.forEach((x,i)=>{
    const tr = document.createElement('tr');
    const mL = (x.mg * (1/concs[x.drug])).toFixed(1);
    tr.innerHTML = `<td>${fmt(new Date(x.ts))}</td><td>${DRUGS[x.drug].name}</td><td class="right">${x.mg}</td><td class="right">${mL}</td><td><button class="pill" onclick="del('${x.ts}')">삭제</button></td>`;
    tbody.appendChild(tr);
  });
  // daily totals (conservative low end max)
  const w = store.get().weight||0;
  const since24 = Date.now()-24*3600*1000;
  const in24 = rows.filter(x=>new Date(x.ts).getTime()>=since24);
  const totals = {APAP:0, IBU:0, DEX:0};
  in24.forEach(x=>totals[x.drug]+=x.mg);
  const apapMax = w*DRUGS.APAP.maxDailyMgKgRange[0];
  const ibuMax  = w*DRUGS.IBU.maxDailyMgKgRange[0];
  const dexMax  = w*DRUGS.DEX.maxDailyMgKgRange[0];
  document.getElementById('dailyTotals').innerHTML =
    `최근 24시간 누계 — 아세트아미노펜 <b>${Math.round(totals.APAP)}</b> / ${Math.round(apapMax)} mg, ` +
    `이부프로펜 <b>${Math.round(totals.IBU)}</b> / ${Math.round(ibuMax)} mg, ` +
    `덱시부프로펜 <b>${Math.round(totals.DEX)}</b> / ${Math.round(dexMax)} mg`;
}

function del(ts){
  const s = store.get(); s.log = (s.log||[]).filter(x=>x.ts!==ts); store.set(s);
  renderLog(); draw();
}

function clearToday(){
  const s = store.get();
  const start = new Date(); start.setHours(0,0,0,0);
  s.log = (s.log||[]).filter(x=>new Date(x.ts).getTime()<start.getTime()); store.set(s);
  renderLog(); draw();
}

function clearAll(){
  if(!confirm('모든 기록을 삭제할까요?')) return;
  store.set({weight: store.get().weight, concAPAP:store.get().concAPAP, concAPAPml:store.get().concAPAPml,
             concIBU:store.get().concIBU, concIBUml:store.get().concIBUml, concDEX:store.get().concDEX, concDEXml:store.get().concDEXml});
  renderLog(); draw();
}

function toLocalInputValue(d){
  const z = new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,16);
}
function fmt(d){
  const p = n=>String(n).padStart(2,'0');
  return `${d.getMonth()+1}/${d.getDate()} ${p(d.getHours())}:${p(d.getMinutes())}`;
}

// PK MODEL
function pkSum(drugKey, t0, t1, stepMin){
  const s = store.get(); const arr = s.log||[];
  const doses = arr.filter(x=>x.drug===drugKey);
  const d = DRUGS[drugKey];
  const Ke = Math.log(2)/d.tHalf;
  const Ka = d.Ka;
  const points = [];
  for(let t=t0; t<=t1; t+=stepMin*60*1000){
    let C = 0;
    for(const dd of doses){
      const dt = (t - new Date(dd.ts).getTime())/3600000; // hours
      if(dt>0){
        // Bateman function; scale by dose (arbitrary Vd & F -> relative index)
        C += dd.mg * (Ka/(Ka-Ke)) * (Math.exp(-Ke*dt) - Math.exp(-Ka*dt));
      }
    }
    points.push({t, C});
  }
  // normalize to 0..1 based on max in window for stable plotting
  let maxC = 0; for(const p of points){ if(p.C>maxC) maxC = p.C; }
  const norm = maxC>0? points.map(p=>({t:p.t, y:p.C/maxC})) : points.map(p=>({t:p.t, y:0}));
  return {norm, raw:points, maxC};
}

function draw(){
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const now = Date.now();
  const start = now - 12*3600*1000; // 12h back
  const end   = now + 12*3600*1000; // 12h forward
  const stepMin = 6; // 6-min
  const A = pkSum('APAP', start, end, stepMin);
  const I = pkSum('IBU',  start, end, stepMin);
  const D = pkSum('DEX',  start, end, stepMin);

  const mode = document.getElementById('viewMode').value;

  // axes
  const pad = 36; const H = canvas.height, W = canvas.width;
  ctx.strokeStyle = '#e5e7eb'; ctx.beginPath();
  for(let i=0;i<=6;i++){ const x = pad + (W-pad-10)*i/6; ctx.moveTo(x,10); ctx.lineTo(x,H-pad/2); }
  for(let j=0;j<=4;j++){ const y = 10 + (H-pad/2-10)*j/4; ctx.moveTo(pad,y); ctx.lineTo(W-10,y); }
  ctx.stroke();

  const datasets = [
    {data:A.norm, color:'#ff4d6d', label:'아세트아미노펜'},
    {data:I.norm, color:'#5a67d8', label:'이부프로펜'},
    {data:D.norm, color:'#10b981', label:'덱시부프로펜'}
  ];

  function xPos(t){ return pad + (W-pad-10) * ((t-start)/(end-start)); }
  function yPos(y){ const h = H-pad/2-10; return 10 + h*(1-y); }

  if(mode==='overlay'){
    // draw each
    datasets.forEach(ds=>{
      ctx.strokeStyle = ds.color; ctx.lineWidth = 2; ctx.beginPath();
      ds.data.forEach((p,i)=>{ const x=xPos(p.t), y=yPos(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
      // legend
      ctx.fillStyle = ds.color; ctx.fillRect(W-180, 14+16*datasets.indexOf(ds), 10,10);
      ctx.fillStyle = '#111'; ctx.fillText(ds.label, W-165, 23+16*datasets.indexOf(ds));
    });
  }else{
    // stacked "effect index"
    const n = A.norm.map((p,i)=>({t:p.t, y:Math.min(1,(p.y + I.norm[i].y + D.norm[i].y)/3)}));
    ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2; ctx.beginPath();
    n.forEach((p,i)=>{ const x=xPos(p.t), y=yPos(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
    ctx.fillStyle = '#0ea5e9'; ctx.fillRect(W-180, 14, 10,10);
    ctx.fillStyle = '#111'; ctx.fillText('효과 지수(정규화 합산)', W-165, 23);
  }

  // time labels
  ctx.fillStyle='#111'; ctx.font='12px system-ui, sans-serif';
  for(let i=0;i<=6;i++){
    const t = new Date(start + (end-start)*i/6);
    const label = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    ctx.fillText(label, pad + (W-pad-10)*i/6 - 12, H-14);
  }
}

window.addEventListener('load', init);
</script>
</body>
</html>

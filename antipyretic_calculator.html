<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>아이 해열제 계산 · 기록 · 농도그래프 (PK-Enhanced_Final)</title>

<style>
  :root{ --bg:#f6f7f9;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--ring:#e5e7eb;
    --pink:#ff5a7a;--pinkBg:#ffe8ee; --blue:#4f67ff;--blueBg:#e9edff;
    --green:#10b981;--greenBg:#e6fff6;}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-size:13px}
  .wrap{max-width:920px;margin:0 auto;padding:8px}
  h1{font-size:17px;margin:2px 0 8px}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:8px}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .section-title{font-size:12px;color:var(--muted);margin:0 0 6px}
  .chip{font-size:11px;padding:2px 6px;border-radius:999px;background:#f1f5f9;color:#0f172a}
  .pill{border:none;border-radius:10px;padding:7px 9px;background:#0ea5e9;color:#fff;cursor:pointer;font-size:13px}
  .ghost{background:#f1f5f9;color:#0f172a}
  .ghost:hover{background:#e2e8f0}
  .kicker{font-size:11px;color:var(--muted)}
  .big{font-size:17px;font-weight:700}

  .line{display:flex;align-items:center;gap:8px;padding:5px 7px;border:1px solid var(--ring);border-radius:10px;background:#fafbff}
  .line .label{min-width:92px;font-weight:700}
  .inline-input{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:9px;padding:2px 4px}
  .inline-input input{width:38px;border:none;outline:none;font:inherit;background:transparent;text-align:right}
  .inline-input .sep{opacity:.6}
  input[type="number"],input[type="datetime-local"]{font:inherit;border:1px solid #e5e7eb;border-radius:9px;padding:6px 7px;background:#fff}
  input[type="number"]{width:78px}
  .drug-btn{border:none;border-radius:10px;padding:7px 9px;cursor:pointer;font-weight:700;font-size:13px}
  .drug-ap{background:var(--pinkBg);color:var(--pink)}
  .drug-ib{background:var(--blueBg);color:var(--blue)}
  .drug-dx{background:var(--greenBg);color:#069e75}
  .ok{background:#111827;color:#fff}
  /* Unit toggle */
  .seg{display:inline-flex;border:1px solid #e5e7eb;border-radius:9px;overflow:hidden}
  .seg button{padding:6px 10px;border:0;background:#fff;color:#0f172a;cursor:pointer}
  .seg button.active{background:#0f172a;color:#fff}

  /* Graph + toolbar */
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  .toolbar select{border:1px solid #e5e7eb;border-radius:9px;padding:6px 8px;background:#fff;font:inherit}
  .chart-wrap{position:relative}
  canvas{width:100%;max-width:100%;height:34vh;background:#fff;border-radius:10px;display:block}

  /* Summary (compact) */
  .summary{display:flex;align-items:center;gap:10px;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:8px;margin-top:8px}
  .summary.bad{background:#fef2f2;border-color:#fecaca}
  .summary.warn{background:#fffbeb;border-color:#fde68a}
  .badge{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.good{background:#d1fae5;color:#065f46}
  .badge.warn{background:#fef3c7;color:#92400e}
  .badge.bad{background:#fee2e2;color:#991b1b}
  .summary .title{font-size:15px;font-weight:800;margin-right:8px}

  /* Donut */
  .donuts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:760px){ .donuts{grid-template-columns:1fr} }
  .donut-card{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  .donut-label{font-weight:800}
  .donut-sub{font-size:12px;color:#64748b}
  .donut-val{font-size:16px;font-weight:800}
  .donut{width:62px;height:62px;position:relative}
  .donut svg{transform:rotate(-90deg)}
  .donut .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px}

  /* Next-inline bar */
  .nextbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;margin-bottom:8px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:4px}
</style>
</head>

<body>
<div class="wrap">
  <h1>아이 해열제 계산 · 기록 · 농도그래프</h1>

  <!-- Body 영역 전체 동일 (삭제 X) -->

<script>
/* ---------- Storage helpers ---------- */
const store = {
  get(){
    try{
      const v = localStorage.getItem('antipyretic_v1');
      const obj = v ? JSON.parse(v) : {};
      if (typeof obj !== 'object' || obj === null) return {};
      if (!Array.isArray(obj.log)) obj.log = [];
      return obj;
    }catch(e){ return { log: [] }; }
  },
  set(d){
    try{ localStorage.setItem('antipyretic_v1', JSON.stringify(d||{})); }catch(e){}
  }
};

/* ---------- Drug constants (PK 강화 버전) ---------- */
/*
 Ka, Ke (t1/2 기반), Tmax 보정 반영

 아세트아미노펜(APAP)
   - t1/2 ≈ 2.3h
   - Ka ≈ 1.7/h (Tmax ≈ 0.8~1.2h 맞춤)
   - Ke = ln2 / 2.3

 이부프로펜(IBU)
   - t1/2 ≈ 2.0h
   - Ka ≈ 1.2/h (Tmax ≈ 1.2~1.5h)
   - Ke = ln2 / 2.0

 덱시부프로펜(DEX)
   - t1/2 ≈ 1.8h
   - Ka ≈ 1.6/h (Tmax ≈ 0.8h)
   - Ke = ln2 / 1.8
*/
const DRUGS = {
  APAP: {name:'아세트아미노펜', recMgKg:[10,15], maxDailyMgKgRange:[60,75],
         Ka:1.7, Ke:Math.log(2)/2.3, color:'#ff5a7a', key:'APAP', tagClass:'ap'},
  IBU:  {name:'이부프로펜', recMgKg:[5,10], maxDailyMgKgRange:[30,40],
         Ka:1.2, Ke:Math.log(2)/2.0, color:'#4f67ff', key:'IBU', tagClass:'ib'},
  DEX:  {name:'덱시부프로펜', recMgKg:[5,7], maxDailyMgKgRange:[20,30],
         Ka:1.6, Ke:Math.log(2)/1.8, color:'#10b981', key:'DEX', tagClass:'dx'},
};

/* ---------- Utilities ---------- */
function safeNumber(x, fb=0){ const n=parseFloat(x); return isFinite(n)?n:fb; }
function safeDiv(n,d,fb=0){ n=safeNumber(n,NaN); d=safeNumber(d,NaN); if(!isFinite(n)||!isFinite(d)||d<=0) return fb; return n/d; }
function toLocalInputValue(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,16); }
function fmt(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${p(d.getHours())}:${p(d.getMinutes())}`; }

/* ---------- Concentration getter ---------- */
function getConcs(){
  const s = store.get();
  return {
    APAP: safeDiv(s.concAPAP ?? 160, s.concAPAPml ?? 5, 32),
    IBU:  safeDiv(s.concIBU  ?? 100, s.concIBUml  ?? 5, 20),
    DEX:  safeDiv(s.concDEX  ?? 60,  s.concDEXml  ?? 5, 12),
  };
}

let active='APAP';
let centerTs=Date.now();
let unit='mg';

/* ---------- Init ---------- */
function init(){
  const s = store.get();
  document.getElementById('weight').value = s.weight ?? '';
  document.getElementById('saveWeight').onclick = ()=>{
    const s2=store.get();
    s2.weight = safeNumber(document.getElementById('weight').value,null);
    store.set(s2);
    refreshDoseBox(); renderLog(); draw(); renderDonuts(); renderNextBar();
  };

  ['APAP','IBU','DEX'].forEach(k=>{
    const base = (k==='APAP'?'concAPAP':k==='IBU'?'concIBU':'concDEX');
    const baseml = base+'ml';
    document.getElementById(base).value = s[base] ?? document.getElementById(base).value;
    document.getElementById(baseml).value = s[baseml] ?? document.getElementById(baseml).value;
    document.getElementById(base).addEventListener('input', saveConcs);
    document.getElementById(baseml).addEventListener('input', saveConcs);
  });

  document.getElementById('doseTime').value = toLocalInputValue(new Date());
  document.getElementById('doseVal').addEventListener('input', updateConversionHint);

  refreshDoseBox(); renderLog(); draw(); renderDonuts(); renderNextBar();
  window.addEventListener('resize', draw);
}

/* ---------- Unit toggle ---------- */
function setUnit(u){
  unit=u;
  const seg=document.querySelectorAll('#unitSeg button');
  seg.forEach(b=>b.classList.toggle('active', b.dataset.u===u));
  document.getElementById('doseVal').value='';
  updateConversionHint();
}

/* ---------- Conversion hint ---------- */
function updateConversionHint(){
  const v=safeNumber(document.getElementById('doseVal').value,NaN);
  const concs=getConcs();
  const conc = concs[active];
  const el=document.getElementById('doseConv');
  if(!isFinite(v)){ el.textContent=''; return; }
  if(unit==='mg') el.textContent = `→ ${(v/(conc||1)).toFixed(1)} ml`;
  else el.textContent = `→ ${(v*conc).toFixed(0)} mg`;
}

/* ---------- Save concentrations ---------- */
function saveConcs(){
  const s=store.get();
  ['concAPAP','concAPAPml','concIBU','concIBUml','concDEX','concDEXml'].forEach(id=>{
    s[id] = safeNumber(document.getElementById(id).value, s[id] ?? null);
  });
  store.set(s);
  refreshDoseBox(); renderLog(); draw(); renderDonuts();
}
/* ---------- Drug selector ---------- */
function setDose(k){
  active = k;
  document.getElementById('doseTime').value = toLocalInputValue(new Date());
  refreshDoseBox();
  updateConversionHint();
}

/* ---------- Dose box refresh ---------- */
function refreshDoseBox(){
  const w = safeNumber(document.getElementById('weight').value,0);
  const d = DRUGS[active];
  const concs = getConcs();

  if(!w){
    document.getElementById('rangeText').textContent = '체중 입력 필요';
    document.getElementById('weightHint').textContent = '';
    return;
  }

  const [mgMin, mgMax] = d.recMgKg;
  const minMg = w * mgMin;
  const maxMg = w * mgMax;
  const mlPerMg = 1 / (concs[active]||1);

  document.getElementById('rangeText').textContent =
    `${Math.round(minMg)}~${Math.round(maxMg)} mg (≈ ${(minMg*mlPerMg).toFixed(1)}~${(maxMg*mlPerMg).toFixed(1)} ml)`;

  const [maxDailyLo, maxDailyHi] = d.maxDailyMgKgRange;
  document.getElementById('maxDaily').innerHTML =
    `24시간 최대: <b>${maxDailyLo}~${maxDailyHi} mg/kg</b>`;
  document.getElementById('weightHint').textContent = '권장 범위 자동 계산 중';
}

/* ---------- Add dose ---------- */
function addDose(){
  const s = store.get();
  const arr = Array.isArray(s.log) ? s.log : [];

  let v = safeNumber(document.getElementById('doseVal').value,NaN);
  if(!isFinite(v)){ alert("용량을 입력해주세요."); return; }

  if(unit === 'ml'){
    const conc = getConcs()[active]||0;
    v = Math.round(v * conc);
  } else {
    v = Math.round(v);
  }

  const tStr = document.getElementById('doseTime').value;
  const tMs = Date.parse(tStr);
  if(!isFinite(tMs)){ alert("시간을 확인해주세요."); return; }

  arr.push({ts:new Date(tMs).toISOString(), drug:active, mg:v});
  s.log = arr;
  store.set(s);

  document.getElementById('doseVal').value='';
  updateConversionHint();
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

/* ---------- Log rendering ---------- */
function renderLog(){
  const s = store.get();
  const arr = Array.isArray(s.log) ? s.log : [];
  const since24 = Date.now() - 24*3600*1000;

  const rows = arr
    .filter(x=>Date.parse(x.ts)>=since24)
    .sort((a,b)=>Date.parse(b.ts)-Date.parse(a.ts));

  const tbody = document.querySelector('#logTbl tbody');
  tbody.innerHTML = '';

  const concs = getConcs();
  const w = safeNumber(store.get().weight,0);
  const totals = {APAP:0, IBU:0, DEX:0};

  rows.forEach(x=>{
    totals[x.drug] += x.mg;
    const ml = (x.mg/(concs[x.drug]||1)).toFixed(1);
    const maxMg = w * DRUGS[x.drug].maxDailyMgKgRange[0];

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmt(new Date(Date.parse(x.ts)))}</td>
      <td><span class="tag ${DRUGS[x.drug].tagClass}">${DRUGS[x.drug].name}</span></td>
      <td class="right">${x.mg}</td>
      <td class="right">${ml}</td>
      <td class="right">${Math.round(totals[x.drug])} / ${Math.round(maxMg||0)} mg</td>
      <td><button class="pill ghost" onclick="del('${x.ts}')">삭제</button></td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('dailyTotals').innerHTML =
    `최근 24시간 누계 — 아세트 <b>${totals.APAP}</b> mg, 이부 <b>${totals.IBU}</b> mg, 덱시부 <b>${totals.DEX}</b> mg`;
}

function del(ts){
  const s = store.get();
  s.log = (s.log||[]).filter(x=>x.ts!==ts);
  store.set(s);
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

/* ---------- Clear ---------- */
function clearToday(){
  const s = store.get();
  const start=new Date(); start.setHours(0,0,0,0);
  s.log = (s.log||[]).filter(x=>Date.parse(x.ts)<start.getTime());
  store.set(s);
  renderLog(); draw(); renderDonuts(); renderNextBar();
}
function clearAll(){
  if(!confirm('모든 기록을 삭제할까요?')) return;
  const keep = store.get();
  store.set({
    weight:keep.weight,
    concAPAP:keep.concAPAP, concAPAPml:keep.concAPAPml,
    concIBU:keep.concIBU, concIBUml:keep.concIBUml,
    concDEX:keep.concDEX, concDEXml:keep.concDEXml,
    log:[]
  });
  renderLog(); draw(); renderDonuts(); renderNextBar();
}

/* ---------- Donut calculation ---------- */
function donutSVG({size=62,stroke=8,percent=0.3,color='#0ea5e9',bg='#eef2ff'}){
  const r = (size-stroke)/2;
  const c = 2*Math.PI*r;
  const p = Math.max(0,Math.min(1,percent));
  const dash=`${p*c} ${c}`;
  return `
    <div class="donut">
      <svg width="${size}" height="${size}">
        <circle cx="${size/2}" cy="${size/2}" r="${r}"
                stroke="${bg}" stroke-width="${stroke}" fill="none" />
        <circle cx="${size/2}" cy="${size/2}" r="${r}"
                stroke="${color}" stroke-width="${stroke}" fill="none"
                stroke-dasharray="${dash}" stroke-linecap="round"/>
      </svg>
      <div class="center">${Math.round(p*100)}%</div>
    </div>`;
}

function renderDonuts(){
  const w = safeNumber(document.getElementById('weight').value,0);
  const wrap = document.getElementById('donutWrap');
  wrap.innerHTML='';

  if(!w){
    wrap.innerHTML='<div class="kicker" style="padding:4px 2px">체중을 입력하면 계산돼요.</div>';
    return;
  }

  const s = store.get();
  const arr = s.log||[];
  const since24 = Date.now() - 24*3600*1000;
  const in24 = arr.filter(x=>Date.parse(x.ts)>=since24);

  const totals = {APAP:0, IBU:0, DEX:0};
  in24.forEach(x=> totals[x.drug]+=x.mg);

  const conc = getConcs();

  [
    {key:'APAP', color:'#ff5a7a'},
    {key:'IBU', color:'#4f67ff'},
    {key:'DEX', color:'#10b981'}
  ].forEach(it=>{
    const maxMg = w * DRUGS[it.key].maxDailyMgKgRange[0];
    const used = totals[it.key];
    const leftMg = Math.max(0, maxMg-used);
    const leftml = leftMg/(conc[it.key]||1);
    const p = Math.min(1, used/(maxMg||1));

    const card=document.createElement('div');
    card.className='donut-card';
    card.innerHTML = `
      ${donutSVG({percent:p,color:it.color,bg:'#eef2f7'})}
      <div>
        <div class="donut-label">${DRUGS[it.key].name}</div>
        <div class="donut-sub">오늘 더 먹을 수 있는 양</div>
        <div class="donut-val" style="color:${it.color}">
          ${leftml.toFixed(1)} ml <span class="donut-sub">(≈ ${Math.round(leftMg)} mg)</span>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}

/* ---------- PK engine (Tmax 기반 개선형 Bateman) ---------- */
/*
  C(t) = (Dose * Ka / (Ka - Ke)) * (e^(-Ke t) - e^(-Ka t))
  → 상대값(정규화)로 사용 (실제 농도 μg/mL 단위 X)
*/
function pkRaw(drugKey, t0, t1, stepMin){
  const s = store.get();
  const doses = (s.log||[]).filter(x=>x.drug===drugKey);

  const {Ka, Ke} = DRUGS[drugKey];
  const result=[];
  for(let t=t0; t<=t1; t+=stepMin*60000){
    let C=0;
    for(const d of doses){
      const dt = (t - Date.parse(d.ts))/3600000; // h
      if(dt>0){
        C += d.mg * (Ka/(Ka-Ke)) * (Math.exp(-Ke*dt) - Math.exp(-Ka*dt));
      }
    }
    result.push({t, C});
  }
  return result;
}
/* ---------- Window-normalized Series ---------- */
function getSeries(start, end, stepMin, yMode){
  function norm(list){
    let max = 0;
    list.forEach(p=>{ if(p.C > max) max = p.C; });
    if(max <= 0) max = 1;
    return list.map(p=>({t:p.t, y:p.C/max}));
  }
  return {
    A: norm(pkRaw('APAP',start,end,stepMin)),
    I: norm(pkRaw('IBU', start,end,stepMin)),
    D: norm(pkRaw('DEX', start,end,stepMin)),
  };
}

/* ---------- Current indices ---------- */
function getIdx(series, start, end){
  const now = Date.now();
  const total = series.A.length;
  const idx = Math.max(0, Math.min(total-1,
          Math.round((now - start)/((end-start)/(total-1)))));
  return {
    now,
    apap: series.A[idx].y,
    ibu:  series.I[idx].y,
    dex:  series.D[idx].y,
    combo: Math.min(1,(series.A[idx].y + series.I[idx].y + series.D[idx].y)/3)
  };
}

/* ---------- Summary card ---------- */
function renderSummary(info){
  const el = document.getElementById('summaryCard');
  const band = parseFloat(document.getElementById('effectBand').value);
  let grade = 'bad';
  if(info.combo >= 0.5) grade='good';
  else if(info.combo >= band) grade='warn';

  const badge = grade==='good'?'충분':grade==='warn'?'경계':'낮음';
  const badgeClass = grade==='good'?'good':grade==='warn'?'warn':'bad';

  const d = new Date(info.now);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');

  el.className = `summary ${grade}`;
  el.style.display = 'flex';
  el.innerHTML = `
    <span class="badge ${badgeClass}">${badge}</span>
    <div>
      <div><span class="title">현재 효과 지수</span><b>${info.combo.toFixed(2)}</b> · ${hh}:${mm}</div>
      <div class="kicker">아세 ${info.apap.toFixed(2)} · 이부 ${info.ibu.toFixed(2)} · 덱시 ${info.dex.toFixed(2)}</div>
    </div>`;
}

/* ---------- Graph drawing ---------- */
function draw(){
  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');

  // iOS Safari canvas fix
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  canvas.width  = cssW || 360;
  canvas.height = cssH || 240;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  const windowH = parseInt(document.getElementById('windowH').value);
  const start = centerTs - windowH*3600*500;
  const end   = centerTs + windowH*3600*500;
  const stepMin = 6;

  const series = getSeries(start,end,stepMin,'fixed');

  const padL=48, padR=8, padT=8, padB=28;
  const H = canvas.height, W = canvas.width;
  const xPos = t => padL+(W-padL-padR)*((t-start)/(end-start));
  const yPos = y => padT + (H-padT-padB)*(1-y);

  /* grid */
  ctx.strokeStyle='#e5e7eb';
  ctx.beginPath();
  for(let i=0;i<=6;i++){
    const x=xPos(start+(end-start)*i/6);
    ctx.moveTo(x,padT); ctx.lineTo(x,H-padB);
  }
  for(let j=0;j<=4;j++){
    const y=padT+(H-padT-padB)*j/4;
    ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);
  }
  ctx.stroke();

  /* effect band */
  const band = parseFloat(document.getElementById('effectBand').value);
  if(band>0){
    ctx.fillStyle='rgba(14,165,233,0.12)';
    ctx.fillRect(padL,yPos(1),W-padL-padR,yPos(band)-yPos(1));
  }

  /* y axis labels */
  ctx.fillStyle='#64748b';
  ctx.font='11px sans-serif';
  [0,0.25,0.5,0.75,1].forEach(v=> ctx.fillText(v, 8, yPos(v)+4));

  /* draw curves */
  const curves = [
    {k:'A', color:'#ff5a7a', name:'아세트아미노펜'},
    {k:'I', color:'#4f67ff', name:'이부프로펜'},
    {k:'D', color:'#10b981', name:'덱시부프로펜'}
  ];
  const mode = document.getElementById('viewMode').value;

  if(mode==='overlay'){
    curves.forEach((c,idx)=>{
      ctx.strokeStyle = c.color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      series[c.k].forEach((p,i)=>{
        const x=xPos(p.t), y=yPos(p.y);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      ctx.fillStyle=c.color;
      ctx.fillRect(W-160,32+16*idx,10,10);
      ctx.fillStyle='#0f172a';
      ctx.fillText(c.name,W-145,40+16*idx);
    });
  } else {
    const N = series.A.map((p,i)=>({
      t:p.t,
      y: Math.min(1,(p.y + series.I[i].y + series.D[i].y)/3)
    }));
    ctx.strokeStyle='#111827';
    ctx.lineWidth=2;
    ctx.beginPath();
    N.forEach((p,i)=>{ const x=xPos(p.t), y=yPos(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
  }

  /* now line */
  const now = Date.now();
  if(now>=start && now<=end){
    const x=xPos(now);
    ctx.strokeStyle='rgba(2,6,23,0.25)';
    ctx.beginPath();
    ctx.moveTo(x,padT); ctx.lineTo(x,H-padB);
    ctx.stroke();
  }

  /* x axis labels */
  ctx.fillStyle='#0f172a';
  ctx.font='11px sans-serif';
  for(let i=0;i<=6;i++){
    const t=new Date(start+(end-start)*i/6);
    const hh = String(t.getHours()).padStart(2,'0');
    const mm = String(t.getMinutes()).padStart(2,'0');
    ctx.fillText(`${hh}:${mm}`, padL+(W-padL-padR)*i/6 - 14, H-10);
  }

  /* summary */
  const info = getIdx(series,start,end);
  renderSummary(info);
}

/* ---------- Pan / recenter ---------- */
function pan(h){ centerTs += h*3600*1000; draw(); }
function nowCenter(){ centerTs = Date.now(); draw(); }

/* ---------- Next Bar (복용 가능 시간) ---------- */
function renderNextBar(){
  const bar=document.getElementById('nextBar');
  const s=store.get();
  const arr=(s.log||[]).slice().sort((a,b)=>Date.parse(b.ts)-Date.parse(a.ts));
  if(!arr.length){ bar.style.display='none'; return; }
  bar.style.display='flex';

  const last = arr[0];
  const lastDrug = last.drug;
  const lastTime = Date.parse(last.ts);
  const now = Date.now();

  function fmtHM(ms){
    const m=Math.floor(ms/60000);
    if (m<60) return `${m}분`;
    const h=Math.floor(m/60), r=m%60;
    return `${h}시간 ${r}분`;
  }

  document.getElementById('nb_last').textContent = fmt(new Date(lastTime));
  document.getElementById('nb_elapsed').textContent = fmtHM(now-lastTime);

  /* 교차 복용 규칙 */
  const rule = {
    APAP: {APAP:4, IBU:2, DEX:2},
    IBU:  {APAP:2, IBU:6, DEX:6},
    DEX:  {APAP:2, IBU:6, DEX:6}
  };
  const r = rule[lastDrug];

  function allowTime(drug){
    const h = r[drug];
    const t = lastTime + h*3600*1000;
    return (now>=t) ? '지금' : fmt(new Date(t));
  }

  document.getElementById('nb_apap').textContent = allowTime('APAP');
  document.getElementById('nb_ibu').textContent  = allowTime('IBU');
  document.getElementById('nb_dex').textContent  = allowTime('DEX');
}

/* ---------- INIT ---------- */
window.addEventListener('load',()=>{
  init();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>아이 해열제 계산 · 기록 · 농도그래프 (v3.3_stable_merged)</title>
<style>
  :root{
    --bg:#f6f7f9;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--ring:#e5e7eb;
    --pink:#ff5a7a;--pinkBg:#ffe8ee; --blue:#4f67ff;--blueBg:#e9edff;
    --green:#10b981;--greenBg:#e6fff6;
  }
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink);font-size:13px}
  .wrap{max-width:920px;margin:0 auto;padding:8px}
  h1{font-size:17px;margin:2px 0 8px}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:8px}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .section-title{font-size:12px;color:var(--muted);margin:0 0 6px}
  .chip{font-size:11px;padding:2px 6px;border-radius:999px;background:#f1f5f9;color:#0f172a}
  .pill{border:none;border-radius:10px;padding:7px 9px;background:#0ea5e9;color:#fff;cursor:pointer;font-size:13px}
  .ghost{background:#f1f5f9;color:#0f172a}
  .ghost:hover{background:#e2e8f0}
  .kicker{font-size:11px;color:var(--muted)}
  .big{font-size:17px;font-weight:700}

  .line{display:flex;align-items:center;gap:8px;padding:5px 7px;border:1px solid var(--ring);border-radius:10px;background:#fafbff}
  .line .label{min-width:92px;font-weight:700}
  .inline-input{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:9px;padding:2px 4px}
  .inline-input input{width:38px;border:none;outline:none;font:inherit;background:transparent;text-align:right}
  .inline-input .sep{opacity:.6}
  input[type="number"],input[type="datetime-local"]{font:inherit;border:1px solid #e5e7eb;border-radius:9px;padding:6px 7px;background:#fff}
  input[type="number"]{width:78px}

  .drug-btn{border:none;border-radius:10px;padding:7px 9px;cursor:pointer;font-weight:700;font-size:13px}
  .drug-ap{background:var(--pinkBg);color:var(--pink)}
  .drug-ib{background:var(--blueBg);color:var(--blue)}
  .drug-dx{background:var(--greenBg);color:#069e75}
  .ok{background:#111827;color:#fff}

  .seg{display:inline-flex;border:1px solid #e5e7eb;border-radius:9px;overflow:hidden}
  .seg button{padding:6px 10px;border:0;background:#fff;color:#0f172a;cursor:pointer}
  .seg button.active{background:#0f172a;color:#fff}

  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  .toolbar select{border:1px solid #e5e7eb;border-radius:9px;padding:6px 8px;background:#fff;font:inherit}
  .chart-wrap{position:relative}
  canvas{width:100%;max-width:100%;height:34vh;background:#fff;border-radius:10px;display:block}

  .summary{display:flex;align-items:center;gap:10px;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:8px;margin-top:8px}
  .summary.bad{background:#fef2f2;border-color:#fecaca}
  .summary.warn{background:#fffbeb;border-color:#fde68a}
  .badge{padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.good{background:#d1fae5;color:#065f46}
  .badge.warn{background:#fef3c7;color:#92400e}
  .badge.bad{background:#fee2e2;color:#991b1b}
  .summary .title{font-size:15px;font-weight:800;margin-right:8px}

  .donuts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:760px){ .donuts{grid-template-columns:1fr} }
  .donut-card{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  .donut-label{font-weight:800}
  .donut-sub{font-size:12px;color:#64748b}
  .donut-val{font-size:16px;font-weight:800}
  .donut{width:62px;height:62px;position:relative}
  .donut svg{transform:rotate(-90deg)}
  .donut .center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px}

  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:11px;color:#64748b;text-align:left;padding:6px 8px;white-space:nowrap}
  tbody tr{background:#ffffff;border:1px solid #e5e7eb}
  tbody td{padding:8px 10px;vertical-align:middle}
  tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  td.right{text-align:right}
  .tag{padding:2px 6px;border-radius:999px;font-size:11px;font-weight:700;white-space:nowrap}
  .tag.ap{background:var(--pinkBg);color:var(--pink)}
  .tag.ib{background:var(--blueBg);color:var(--blue)}
  .tag.dx{background:var(--greenBg);color:#069e75}

  .nextbar{display:flex;flex-direction:column;gap:4px;font-size:12px;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;margin-bottom:8px}
  .nextbar .line1{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .nextbar .line2{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .dot{display:inline-block;width:7px;height:7px;border-radius:999px;margin-right:5px;vertical-align:middle}
</style>
</head>
<body>
<div class="wrap">
  <h1>아이 해열제 계산 · 기록 · 농도그래프</h1>

  <div class="grid cols-2">
    <div class="card">
      <div class="section-title">기본 정보</div>
      <div class="row">
        <span class="chip">체중(kg)</span>
        <input id="weight" type="number" step="0.1" min="3" max="80" />
        <button id="saveWeight" class="pill ghost">저장</button>
        <span id="weightHint" class="kicker"></span>
      </div>

      <div class="section-title" style="margin-top:4px">현용 현탁농도 (필요시만 변경)</div>
      <div class="line">
        <div class="label">아세트아미노펜</div>
        <div class="inline-input">
          <input id="concAPAP" type="number" step="1" value="160"><span class="sep">mg /</span>
          <input id="concAPAPml" type="number" step="0.1" value="5"><span class="sep">ml</span>
        </div>
      </div>
      <div class="line">
        <div class="label">이부프로펜</div>
        <div class="inline-input">
          <input id="concIBU" type="number" step="1" value="100"><span class="sep">mg /</span>
          <input id="concIBUml" type="number" step="0.1" value="5"><span class="sep">ml</span>
        </div>
      </div>
      <div class="line">
        <div class="label">덱시부프로펜</div>
        <div class="inline-input">
          <input id="concDEX" type="number" step="1" value="60"><span class="sep">mg /</span>
          <input id="concDEXml" type="number" step="0.1" value="5"><span class="sep">ml</span>
        </div>
      </div>
      <div class="kicker" style="margin-top:2px">숫자를 바꾸면 자동 저장돼요.</div>
    </div>

    <div class="card">
      <div class="row">
        <button class="drug-btn drug-ap" onclick="setDose('APAP')">아세트아미노펜</button>
        <button class="drug-btn drug-ib" onclick="setDose('IBU')">이부프로펜</button>
        <button class="drug-btn drug-dx" onclick="setDose('DEX')">덱시부프로펜</button>
      </div>

      <div id="doseBox" style="margin-top:6px">
        <div class="row">
          <div class="chip">권장 1회 용량</div>
          <div id="rangeText" class="big"></div>
        </div>

        <div class="row">
          <div class="chip">투여 용량</div>
          <div class="seg" id="unitSeg">
            <button type="button" data-u="mg" class="active" onclick="setUnit('mg')">mg</button>
            <button type="button" data-u="ml" onclick="setUnit('ml')">ml</button>
          </div>
          <input id="doseVal" type="number" step="1" placeholder="값 입력" />
          <span id="doseConv" class="kicker"></span>
        </div>

        <div class="row">
          <div class="chip">복용 시간</div>
          <input id="doseTime" type="datetime-local" />
          <button class="pill ok" onclick="addDose()">기록하기</button>
        </div>

        <div class="kicker" id="maxDaily"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="nextBar" class="nextbar" style="display:none">
      <div class="line1">
        <b>마지막 복용</b>
        <span id="nb_last">—</span>
        <span>/</span>
        <b>경과</b>
        <span id="nb_elapsed">—</span>
      </div>
      <div class="line2">
        <b>다음 복용 가능 시간</b>
        <span>
          <span class="dot" style="background:var(--pink)"></span>
          <span>아세트</span>
          <b id="nb_apap">—</b>
        </span>
        <span>
          <span class="dot" style="background:var(--blue)"></span>
          <span class="dot" style="background:var(--green); margin-left:-2px"></span>
          <span>이부·덱시부</span>
          <b id="nb_ibudex">—</b>
        </span>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="toolbar">
        <button class="pill ghost" onclick="pan(-2)">← 2h</button>
        <button class="pill ghost" onclick="pan(-6)">← 6h</button>
        <button class="pill ghost" onclick="nowCenter()">지금</button>
        <button class="pill ghost" onclick="pan(6)">6h →</button>
        <button class="pill ghost" onclick="pan(12)">12h →</button>
        <select id="windowH" onchange="draw()">
          <option value="12">창: 12h</option>
          <option value="24" selected>창: 24h</option>
          <option value="36">창: 36h</option>
        </select>
        <select id="viewMode" onchange="draw()">
          <option value="overlay">개별 곡선</option>
          <option value="stack">합산 지수</option>
        </select>
        <select id="effectBand" onchange="draw()">
          <option value="0">효과권: 표시 안함</option>
          <option value="0.25">효과권: 지수 ≥ 0.25</option>
          <option value="0.33" selected>효과권: 지수 ≥ 0.33</option>
          <option value="0.5">효과권: 지수 ≥ 0.50</option>
        </select>
        <select id="yMode" onchange="draw()">
          <option value="fixed" selected>Y축: 고정</option>
          <option value="auto">Y축: 자동</option>
        </select>
      </div>
      <div class="kicker">Y축: <b>정규화 상대지수(0~1)</b></div>
    </div>

    <div class="chart-wrap"><canvas id="chart"></canvas></div>
    <div id="summaryCard" class="summary" style="display:none"></div>

    <div class="row" style="margin-top:8px;justify-content:flex-end">
      <button class="pill ghost" onclick="clearToday()">오늘 기록 삭제</button>
      <button class="pill ghost" onclick="clearAll()">전체 초기화</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:2px 0 6px">최근 24시간 복용 이력</h3>
    <table id="logTbl">
      <thead><tr><th>시각</th><th>약</th><th class="right">용량 (mg)</th><th class="right">ml</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="dailyTotals" class="kicker"></div>
  </div>

  <div class="card">
    <h3 style="margin:2px 0 6px">오늘 더 먹을 수 있는 양</h3>
    <div class="donuts" id="donutWrap"></div>
  </div>
</div>

<script>
// (이 파일은 '이부·덱시부'를 한 줄로 묶고, 점(파랑+초록)을 붙여 표기하도록 next bar만 반영한 통합본입니다.)
const store={get(){try{const v=localStorage.getItem('antipyretic_v1');const obj=v?JSON.parse(v):{};if(typeof obj!=='object'||obj===null)return{log:[]};if(!Array.isArray(obj.log))obj.log=[];return obj}catch(e){return{log:[]}}},set(d){try{localStorage.setItem('antipyretic_v1',JSON.stringify(d||{}))}catch(e){}}};

const DRUGS={APAP:{name:'아세트아미노펜',recMgKg:[10,15],maxDailyMgKgRange:[60,75],tagClass:'ap'},IBU:{name:'이부프로펜',recMgKg:[5,10],maxDailyMgKgRange:[30,40],tagClass:'ib'},DEX:{name:'덱시부프로펜',recMgKg:[5,7],maxDailyMgKgRange:[20,30],tagClass:'dx'}};

function safeNumber(x,f=0){const n=parseFloat(x);return isFinite(n)?n:f}
function safeDiv(n,d,fb=0){n=safeNumber(n,NaN);d=safeNumber(d,NaN);if(!isFinite(n)||!isFinite(d)||d<=0)return fb;return n/d}
function toLocalInputValue(d){const z=new Date(d.getTime()-d.getTimezoneOffset()*60000);return z.toISOString().slice(0,16)}
function fmt(d){const p=n=>String(n).padStart(2,'0');return `${d.getMonth()+1}/${d.getDate()} ${p(d.getHours())}:${p(d.getMinutes())}`}

function getConcs(){const s=store.get();return{APAP:safeDiv(s.concAPAP??160,s.concAPAPml??5,32),IBU:safeDiv(s.concIBU??100,s.concIBUml??5,20),DEX:safeDiv(s.concDEX??60,s.concDEXml??5,12)}}

let active='APAP', unit='mg', centerTs=Date.now();

function init(){
  const s=store.get();
  document.getElementById('weight').value=s.weight??'';
  document.getElementById('saveWeight').onclick=()=>{const s2=store.get();s2.weight=safeNumber(document.getElementById('weight').value,null);store.set(s2);refreshDoseBox();renderLog();draw();renderDonuts();renderNextBar();};

  document.getElementById('concAPAP').value=s.concAPAP??160;
  document.getElementById('concAPAPml').value=s.concAPAPml??5;
  document.getElementById('concIBU').value=s.concIBU??100;
  document.getElementById('concIBUml').value=s.concIBUml??5;
  document.getElementById('concDEX').value=s.concDEX??60;
  document.getElementById('concDEXml').value=s.concDEXml??5;

  ['concAPAP','concAPAPml','concIBU','concIBUml','concDEX','concDEXml'].forEach(id=>document.getElementById(id).addEventListener('input',saveConcs));

  document.getElementById('doseTime').value=toLocalInputValue(new Date());
  document.getElementById('doseVal').addEventListener('input',updateConversionHint);

  refreshDoseBox();renderLog();draw();renderDonuts();renderNextBar();
  window.addEventListener('resize',draw);
}

function setUnit(u){unit=u;document.getElementById('unitSeg').querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.u===u));document.getElementById('doseVal').value='';updateConversionHint();}
function updateConversionHint(){const v=safeNumber(document.getElementById('doseVal').value,NaN);const conc=(getConcs()[active]||0);const el=document.getElementById('doseConv');if(!isFinite(v)){el.textContent='';return;}el.textContent=(unit==='mg')?`→ ${(v/(conc||1)).toFixed(1)} ml 예상`:`→ ${(v*conc).toFixed(0)} mg 환산`;}
function saveConcs(){const s=store.get();['concAPAP','concAPAPml','concIBU','concIBUml','concDEX','concDEXml'].forEach(id=>{s[id]=safeNumber(document.getElementById(id).value,s[id]??null)});store.set(s);refreshDoseBox();draw();renderDonuts();renderLog();updateConversionHint();}
function setDose(k){active=k;document.getElementById('doseTime').value=toLocalInputValue(new Date());refreshDoseBox();updateConversionHint();}

function refreshDoseBox(){
  const w=safeNumber(document.getElementById('weight').value,0);
  const d=DRUGS[active];const concs=getConcs();
  if(!w){document.getElementById('rangeText').textContent='체중 입력 필요';document.getElementById('weightHint').textContent='';return;}
  const [minMgKg,maxMgKg]=d.recMgKg;
  const minMg=w*minMgKg,maxMg=w*maxMgKg;
  const mlperMg=1/(concs[active]||1);
  document.getElementById('rangeText').textContent=`${Math.round(minMg)}~${Math.round(maxMg)} mg (≈ ${(minMg*mlperMg).toFixed(1)}~${(maxMg*mlperMg).toFixed(1)} ml)`;
  const [lo,hi]=d.maxDailyMgKgRange;
  document.getElementById('maxDaily').innerHTML=`24시간 최대: <b>${lo}~${hi} mg/kg</b> (기관마다 차이). 보수 계산은 낮은 값으로 평가.`;
  document.getElementById('weightHint').textContent='권장 범위 자동 계산 중';
}

function addDose(){
  const s=store.get();const arr=Array.isArray(s.log)?s.log:[];
  let v=safeNumber(document.getElementById('doseVal').value,NaN);
  if(!isFinite(v)){alert('용량을 입력해주세요.');return;}
  if(unit==='ml'){const conc=getConcs()[active]||0;v=Math.round(v*conc);} else v=Math.round(v);
  const tMs=Date.parse(document.getElementById('doseTime').value);
  if(!isFinite(tMs)){alert('시간을 확인해주세요.');return;}
  arr.push({ts:new Date(tMs).toISOString(),drug:active,mg:v});s.log=arr;store.set(s);
  document.getElementById('doseVal').value='';updateConversionHint();
  renderLog();draw();renderDonuts();renderNextBar();
}

function renderLog(){
  const s=store.get();const arr=Array.isArray(s.log)?s.log:[];
  const since24=Date.now()-24*3600*1000;
  const rows=arr.filter(x=>Date.parse(x.ts)>=since24).sort((a,b)=>Date.parse(b.ts)-Date.parse(a.ts));
  const tbody=document.querySelector('#logTbl tbody');tbody.innerHTML='';
  const concs=getConcs();const totals={APAP:0,IBU:0,DEX:0};
  rows.forEach(x=>{
    totals[x.drug]=(totals[x.drug]||0)+(x.mg||0);
    const ml=(x.mg/(concs[x.drug]||1)).toFixed(1);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(new Date(Date.parse(x.ts)))}</td>
      <td><span class="tag ${DRUGS[x.drug].tagClass}">${DRUGS[x.drug].name}</span></td>
      <td class="right">${x.mg}</td>
      <td class="right">${ml}</td>
      <td><button class="pill ghost" onclick="delDose('${x.ts}')">삭제</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('dailyTotals').innerHTML=`최근 24시간 누계 — 아세트아미노펜 <b>${Math.round(totals.APAP||0)}</b> mg, 이부프로펜 <b>${Math.round(totals.IBU||0)}</b> mg, 덱시부프로펜 <b>${Math.round(totals.DEX||0)}</b> mg`;
}

function delDose(ts){const s=store.get();s.log=(s.log||[]).filter(x=>x.ts!==ts);store.set(s);renderLog();draw();renderDonuts();renderNextBar();}
function clearToday(){const s=store.get();const start=new Date();start.setHours(0,0,0,0);s.log=(s.log||[]).filter(x=>Date.parse(x.ts)<start.getTime());store.set(s);renderLog();draw();renderDonuts();renderNextBar();}
function clearAll(){if(!confirm('모든 기록을 삭제할까요?'))return;const keep=store.get();store.set({weight:keep.weight,concAPAP:keep.concAPAP,concAPAPml:keep.concAPAPml,concIBU:keep.concIBU,concIBUml:keep.concIBUml,concDEX:keep.concDEX,concDEXml:keep.concDEXml,log:[]});renderLog();draw();renderDonuts();renderNextBar();}

function donutSVG({size=62,stroke=8,percent=0.3,color='#0ea5e9',bg='#eef2ff'}){const r=(size-stroke)/2;const c=2*Math.PI*r;const p=Math.max(0,Math.min(1,percent));const dash=`${p*c} ${c}`;return `<div class="donut"><svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="${bg}" stroke-width="${stroke}" fill="none" /><circle cx="${size/2}" cy="${size/2}" r="${r}" stroke="${color}" stroke-width="${stroke}" fill="none" stroke-dasharray="${dash}" stroke-linecap="round" /></svg><div class="center">${Math.round(p*100)}%</div></div>`;}
function renderDonuts(){
  const w=safeNumber(document.getElementById('weight').value,0);
  const wrap=document.getElementById('donutWrap');wrap.innerHTML='';
  if(!w){wrap.innerHTML='<div class="kicker" style="padding:4px 2px">체중을 입력하면 계산돼요.</div>';return;}
  const s=store.get();const arr=s.log||[];const since24=Date.now()-24*3600*1000;const in24=arr.filter(x=>Date.parse(x.ts)>=since24);
  const totals={APAP:0,IBU:0,DEX:0};in24.forEach(x=>{totals[x.drug]=(totals[x.drug]||0)+(x.mg||0)});
  const conc=getConcs();
  [{key:'APAP',color:'#ff5a7a'},{key:'IBU',color:'#4f67ff'},{key:'DEX',color:'#10b981'}].forEach(it=>{
    const maxMg=w*DRUGS[it.key].maxDailyMgKgRange[0];const used=totals[it.key]||0;
    const leftMg=Math.max(0,(maxMg||0)-used);const leftml=leftMg/(conc[it.key]||1);
    const percent=Math.min(1,used/(maxMg||1));
    const card=document.createElement('div');card.className='donut-card';
    card.innerHTML=`${donutSVG({percent,color:it.color,bg:'#eef2f7'})}<div><div class="donut-label">${DRUGS[it.key].name}</div><div class="donut-sub">오늘 더 먹을 수 있는 양</div><div class="donut-val" style="color:${it.color}">${leftml.toFixed(1)} ml <span class="donut-sub">(≈ ${Math.round(leftMg)} mg)</span></div></div>`;
    wrap.appendChild(card);
  });
}

function renderNextBar(){
  const bar=document.getElementById('nextBar');
  const s=store.get();const arr=(s.log||[]).slice().sort((a,b)=>Date.parse(b.ts)-Date.parse(a.ts));
  if(!arr.length){bar.style.display='none';return;}
  bar.style.display='block';
  const last=arr[0];const lastDrug=last.drug;const lastTime=Date.parse(last.ts);const now=Date.now();
  const fmtElapsed=ms=>{const m=Math.max(0,Math.floor(ms/60000));if(m<60)return `${m}분`;const h=Math.floor(m/60),r=m%60;return `${h}시간 ${r}분`;};
  document.getElementById('nb_last').textContent=fmt(new Date(lastTime));
  document.getElementById('nb_elapsed').textContent=fmtElapsed(now-lastTime);
  const rule={APAP:{APAP:4,IBUDEX:2},IBU:{APAP:2,IBUDEX:6},DEX:{APAP:2,IBUDEX:6}};
  const r=(rule[lastDrug]||{APAP:4,IBUDEX:4});
  const label=hours=>{const allow=lastTime+hours*3600*1000;return (now>=allow)?'지금':fmt(new Date(allow));};
  document.getElementById('nb_apap').textContent=label(r.APAP);
  document.getElementById('nb_ibudex').textContent=label(r.IBUDEX);
}

/* 간단 PK 그래프 (기존과 동일한 정규화 곡선) */
const PK={APAP:{tHalf:2.2,Ka:2.0},IBU:{tHalf:2.0,Ka:1.5},DEX:{tHalf:2.2,Ka:1.5}};
function pkPoints(drugKey,t0,t1,stepMin){
  const s=store.get();const log=s.log||[];const dLog=log.filter(x=>x.drug===drugKey);
  const Ke=Math.log(2)/PK[drugKey].tHalf;const Ka=PK[drugKey].Ka;
  const pts=[];
  for(let t=t0;t<=t1;t+=stepMin*60000){
    let C=0;
    for(const dose of dLog){
      const dt=(t-Date.parse(dose.ts))/3600000;
      if(dt>0) C+=(dose.mg||0)*(Ka/(Ka-Ke))*(Math.exp(-Ke*dt)-Math.exp(-Ka*dt));
    }
    pts.push({t,C});
  }
  return pts;
}
function getSeries(start,end,stepMin,yMode){
  let globalMax=1;
  if(yMode==='fixed'){
    const past=Date.now()-24*3600*1000,future=Date.now()+12*3600*1000;
    for(const k of ['APAP','IBU','DEX']){
      for(const p of pkPoints(k,past,future,10)) if(p.C>globalMax) globalMax=p.C;
    }
  }
  const norm=k=>{
    const raw=pkPoints(k,start,end,stepMin);
    if(yMode==='fixed') return raw.map(p=>({t:p.t,y:(globalMax? p.C/globalMax:0)}));
    let localMax=1;raw.forEach(p=>{if(p.C>localMax)localMax=p.C;});
    return raw.map(p=>({t:p.t,y:(localMax? p.C/localMax:0)}));
  };
  return {APAP:norm('APAP'),IBU:norm('IBU'),DEX:norm('DEX')};
}
function draw(){
  const canvas=document.getElementById('chart');const ctx=canvas.getContext('2d');
  const cw=canvas.clientWidth||360,ch=canvas.clientHeight||240;canvas.width=cw;canvas.height=ch;
  ctx.clearRect(0,0,cw,ch);

  const windowH=parseInt(document.getElementById('windowH').value,10);
  const yMode=document.getElementById('yMode').value;
  const mode=document.getElementById('viewMode').value;
  const band=parseFloat(document.getElementById('effectBand').value||'0');

  const start=centerTs-(windowH/2)*3600*1000;
  const end=centerTs+(windowH/2)*3600*1000;

  const series=getSeries(start,end,6,yMode);

  const padL=48,padR=10,padT=8,padB=28,W=cw,H=ch;
  const xPos=t=>padL+(W-padL-padR)*((t-start)/(end-start));
  const yPos=v=>padT+(H-padB-padT)*(1-v);

  ctx.strokeStyle='#e5e7eb';ctx.beginPath();
  for(let i=0;i<=6;i++){const x=padL+(W-padL-padR)*i/6;ctx.moveTo(x,padT);ctx.lineTo(x,H-padB);}
  for(let j=0;j<=4;j++){const y=padT+(H-padB-padT)*j/4;ctx.moveTo(padL,y);ctx.lineTo(W-padR,y);}
  ctx.stroke();

  if(band>0){ctx.fillStyle='rgba(14,165,233,0.12)';ctx.fillRect(padL,yPos(1),W-padL-padR,yPos(band)-yPos(1));}

  ctx.fillStyle='#64748b';ctx.font='11px ui-sans-serif';
  [0,0.25,0.5,0.75,1].forEach(v=>ctx.fillText(String(v),8,yPos(v)+3));

  const colors={APAP:'#ff5a7a',IBU:'#4f67ff',DEX:'#10b981'};
  if(mode==='overlay'){
    ['APAP','IBU','DEX'].forEach(k=>{
      const arr=series[k];ctx.beginPath();ctx.strokeStyle=colors[k];ctx.lineWidth=2;
      arr.forEach((p,i)=>{const x=xPos(p.t),y=yPos(p.y);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
      ctx.stroke();
    });
  }else{
    const A=series.APAP,B=series.IBU,C=series.DEX;
    ctx.beginPath();ctx.strokeStyle='#111827';ctx.lineWidth=2;
    for(let i=0;i<A.length;i++){
      const y=Math.min(1,(A[i].y+(B[i]?.y||0)+(C[i]?.y||0))/3);
      const x=xPos(A[i].t),yy=yPos(y);
      if(i===0)ctx.moveTo(x,yy);else ctx.lineTo(x,yy);
    }
    ctx.stroke();
  }

  const now=Date.now();
  if(now>=start&&now<=end){
    const x=xPos(now);
    ctx.strokeStyle='rgba(2,6,23,0.25)';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(x,padT);ctx.lineTo(x,H-padB);ctx.stroke();
  }

  ctx.font='11px ui-sans-serif';ctx.fillStyle='#0f172a';
  for(let i=0;i<=6;i++){
    const t=new Date(start+(end-start)*i/6);
    const p=n=>String(n).padStart(2,'0');
    ctx.fillText(`${p(t.getHours())}:${p(t.getMinutes())}`, padL+(W-padL-padR)*i/6-16, H-10);
  }

  const pick=(arr)=>{if(!arr.length)return 0;if(now<=start)return arr[0].y||0;if(now>=end)return arr[arr.length-1].y||0;const r=(now-start)/(end-start);const idx=Math.max(0,Math.min(arr.length-1,Math.floor(arr.length*r)));return arr[idx].y||0;};
  const ap=pick(series.APAP), ib=pick(series.IBU), dx=pick(series.DEX), combo=Math.min(1,(ap+ib+dx)/3);
  const el=document.getElementById('summaryCard');const base=parseFloat(document.getElementById('effectBand').value||'0.33');
  let grade='bad'; if(combo>=0.5) grade='good'; else if(combo>=base) grade='warn';
  const badgeText=grade==='good'?'충분':grade==='warn'?'경계':'낮음';
  const badgeClass=grade==='good'?'good':grade==='warn'?'warn':'bad';
  const d=new Date();const p=n=>String(n).padStart(2,'0');const hhmm=`${p(d.getHours())}:${p(d.getMinutes())}`;
  el.style.display='flex';el.className=`summary ${grade}`;
  el.innerHTML=`<span class="badge ${badgeClass}">${badgeText}</span><div><div><span class="title">현재 효과 지수</span><b>${combo.toFixed(2)}</b> (기준 ${base}) · ${hhmm}</div><div class="kicker">아세 ${ap.toFixed(2)} · 이부 ${ib.toFixed(2)} · 덱시 ${dx.toFixed(2)}</div></div>`;
}

function pan(h){centerTs+=h*3600*1000;draw();}
function nowCenter(){centerTs=Date.now();draw();}

window.addEventListener('load', init);
</script>
</body>
</html>
